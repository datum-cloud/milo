apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: crm-note-contact-lifecycle
spec:
  description: |
    End-to-end tests for CRM Notes.

    This test verifies:
    - A Note referencing a Contact and User populates status.createdBy with the User's email
    - Deleting a Contact causes a reconciled Note that references it to be deleted
    - Deleting a User causes owned Notes to be garbage-collected via ownerReferences

  steps:
    - name: create-user-contact-and-notes
      description: Create IAM User, Notification Contact, and CRM Notes, then verify Note status
      try:
        - apply:
            file: 01-test-user.yaml
        - wait:
            apiVersion: iam.miloapis.com/v1alpha1
            kind: User
            name: test-crm-note-user
            timeout: 60s
            for:
              condition:
                name: Ready
                value: 'True'

        - apply:
            file: 02-test-contacts.yaml

        - apply:
            file: 03-test-notes.yaml

        # Wait for Notes to be created and verify owner references are set
        - assert:
            resource:
              apiVersion: notes.miloapis.com/v1alpha1
              kind: Note
              metadata:
                name: test-crm-note-1
              (length(metadata.ownerReferences) > `0`): true

    - name: delete-contact-and-verify-contact-note-deletion
      description: Delete Contact, update the contact Note to trigger reconciliation, and verify the contact Note is deleted
      try:
        # Ensure Contact and contact Note exist before deletion
        - assert:
            resource:
              apiVersion: notification.miloapis.com/v1alpha1
              kind: Contact
              metadata:
                name: test-crm-note-contact-1
                namespace: ($namespace)
        - assert:
            resource:
              apiVersion: notes.miloapis.com/v1alpha1
              kind: Note
              metadata:
                name: test-crm-note-1

        - delete:
            ref:
              apiVersion: notification.miloapis.com/v1alpha1
              kind: Contact
              name: test-crm-note-contact-1
              namespace: ($namespace)
        - wait:
            apiVersion: notification.miloapis.com/v1alpha1
            kind: Contact
            name: test-crm-note-contact-1
            namespace: ($namespace)
            timeout: 60s
            for:
              deletion: {}

        - wait:
            apiVersion: notes.miloapis.com/v1alpha1
            kind: Note
            name: test-crm-note-1
            timeout: 60s
            for:
              deletion: {}


    - name: delete-user-and-verify-user-note-deletion
      description: Delete the IAM User and verify the Note that references the User is garbage-collected
      try:
        # Ensure the user-referencing Note exists before deleting the User
        - assert:
            resource:
              apiVersion: notes.miloapis.com/v1alpha1
              kind: ClusterNote
              metadata:
                name: test-crm-note-2

        - delete:
            ref:
              apiVersion: iam.miloapis.com/v1alpha1
              kind: User
              name: test-crm-note-user

        - wait:
            apiVersion: iam.miloapis.com/v1alpha1
            kind: User
            name: test-crm-note-user
            timeout: 60s
            for:
              deletion: {}
    - name: verify-additional-notes-still-exist
      description: Verify additional Notes are not accidentally deleted by Contact or User deletion
      try:
        - assert:
            resource:
              apiVersion: notes.miloapis.com/v1alpha1
              kind: Note
              metadata:
                name: test-crm-note-3
        - assert:
            resource:
              apiVersion: notes.miloapis.com/v1alpha1
              kind: Note
              metadata:
                name: test-crm-note-4
