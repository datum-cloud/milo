apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: validating-admission-policy-project
spec:
  description: |
    Tests ValidatingAdmissionPolicy for project naming enforcement across organizations.

    This test verifies:
    - ValidatingAdmissionPolicies can enforce organization-specific naming rules
    - Projects with invalid names are rejected
    - Projects with valid prefixes matching their organization are accepted
    - Policies work correctly across multiple organization contexts

  clusters:
    orgA:
      kubeconfig: kubeconfig-org-a
    orgB:
      kubeconfig: kubeconfig-org-b
  steps:
  - name: apply-policy-and-orgs
    description: Create ValidatingAdmissionPolicy and test organizations
    try:
    - apply:
        file: resources/policy.yaml
    - sleep:
        duration: 2s
    - apply:
        file: resources/org-a.yaml
    - apply:
        file: resources/org-b.yaml

  - name: deny-projects-with-bad-names-orgA
    description: Verify projects with invalid names are rejected in orgA
    cluster: orgA
    try:
    - error:
        file: resources/project-bad-a.yaml
  - name: deny-projects-with-bad-names-orgB
    description: Verify projects with invalid names are rejected in orgB
    cluster: orgB
    try:
    - error:
        file: resources/project-bad-b.yaml

  - name: allow-projects-with-ok-prefix-orgA
    description: Verify projects with correct orgA prefix are accepted
    cluster: orgA
    try:
    - apply:
        file: resources/project-good-a.yaml
    - wait:
        apiVersion: resourcemanager.miloapis.com/v1alpha1
        kind: Project
        name: vap-ok-good-a
        timeout: 30s
        for:
          condition:
            name: Ready
            value: 'true'
    - assert:
        file: assertions/assert-project-a-owner.yaml
  - name: allow-projects-with-ok-prefix-orgB
    description: Verify projects with correct orgB prefix are accepted
    cluster: orgB
    try:
    - apply:
        file: resources/project-good-b.yaml
    - wait:
        apiVersion: resourcemanager.miloapis.com/v1alpha1
        kind: Project
        name: vap-ok-good-b
        timeout: 30s
        for:
          condition:
            name: Ready
            value: 'true'
    - assert:
        file: assertions/assert-project-b-owner.yaml
