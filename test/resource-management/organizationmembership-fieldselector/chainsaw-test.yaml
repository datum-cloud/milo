apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: organizationmembership-fieldselector
spec:
  description: |
    Tests field selector functionality for OrganizationMemberships.

    This test verifies:
    - Field selectors work on spec.userRef.name
    - Field selectors work on spec.organizationRef.name
    - Field selectors correctly filter memberships within organization namespaces
    - Non-matching field selectors return zero results

  clusters:
    org:
      kubeconfig: kubeconfig-org-template
  steps:
  - name: setup
    description: Create Organization and OrganizationMemberships for field selector testing
    try:
    - apply:
        file: resources/org.yaml
    - wait:
        apiVersion: v1
        kind: Namespace
        name: organization-fieldsel-org
        timeout: 60s
        for:
          jsonPath:
            path: '{.status.phase}'
            value: Active
    - apply:
        file: resources/membership-user-admin.yaml
    - apply:
        file: resources/membership-user-readonly.yaml
    - wait:
        apiVersion: resourcemanager.miloapis.com/v1alpha1
        kind: OrganizationMembership
        name: m-admin
        namespace: organization-fieldsel-org
        timeout: 60s
        for:
          condition:
            name: Ready
            value: 'True'

  - name: direct-field-selector-on-org-cluster
    description: Test field selector filtering on userRef.name and organizationRef.name
    cluster: org
    try:
    - script:
        timeout: 60s
        content: |
          set -eu
          # spec.userRef.name filter matches exactly one
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=admin -o json | jq '.items | length')" -eq 1
          # non-matching user yields zero
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=does-not-exist -o json | jq '.items | length')" -eq 0
          # organization filter matches both memberships
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.organizationRef.name=fieldsel-org -o json | jq '.items | length')" -eq 2

  - name: org-scoped-fieldselector-behavior
    description: Verify field selector correctly narrows results within organization namespace
    cluster: org
    try:
    - script:
        timeout: 60s
        content: |
          set -eu
          # Plain list returns both memberships
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org -o json | jq '.items | length')" -eq 2
          # Field-select by user narrows the list
          test "$(kubectl get organizationmemberships -n organization-fieldsel-org \
            --field-selector spec.userRef.name=test-user -o json | jq '.items | length')" -eq 1



