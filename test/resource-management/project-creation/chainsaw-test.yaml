apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: project-creation
spec:
  description: |
    Tests basic Project creation and multi-cluster visibility.

    This test verifies:
    - Projects can be created within an Organization namespace
    - Projects reach Ready status
    - Projects are visible in both organization and main cluster contexts
    - User and OrganizationMembership setup works correctly

  # Define clusters for organizational context testing
  clusters:
    main:
      kubeconfig: kubeconfig-main
    org:
      kubeconfig: kubeconfig-org-template

  steps:
    # Create test organization
    - name: setup-organization
      description: Create Organization, User, and OrganizationMembership for project testing
      try:
        - apply:
            file: 01-test-organization.yaml
        - wait:
            apiVersion: v1
            kind: Namespace
            name: organization-test-project-creation-org
            timeout: 30s
            for:
              jsonPath:
                path: '{.status.phase}'
                value: Active
        - apply:
            file: 02-test-user.yaml
        - wait:
            apiVersion: iam.miloapis.com/v1alpha1
            kind: User
            name: "user-admin"
            timeout: 30s
            for:
              condition:
                name: Ready
                value: 'True'
        - apply:
            file: 03-organization-membership.yaml

    # Test project creation and Ready status through organizational context
    - name: test-project-creation-and-ready-status
      description: Create Project in organization context and verify it reaches Ready status
      cluster: org
      try:
        - apply:
            file: 04-test-project.yaml
        - wait:
            apiVersion: resourcemanager.miloapis.com/v1alpha1
            kind: Project
            name: project-creation-test
            timeout: 60s
            for:
              condition:
                name: Ready
                value: 'True'
        - assert:
            file: assertions/assert-project-ready.yaml

    # Verify project shows up in main cluster context with correct status
    - name: verify-project-in-main-cluster
      description: Verify Project is visible in main cluster with correct status
      cluster: main
      try:
        - assert:
            file: assertions/assert-project-exists-main.yaml
