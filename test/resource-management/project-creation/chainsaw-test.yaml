apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: project-creation
spec:
  # Define clusters for organizational context testing
  clusters:
    main:
      kubeconfig: kubeconfig-main
    org:
      kubeconfig: kubeconfig-org-template

  steps:
    # Create test organization
    - name: setup-organization
      try:
        - apply:
            file: 01-test-organization.yaml
        - wait:
            apiVersion: v1
            kind: Namespace
            name: organization-test-project-creation-org
            timeout: 30s
            for:
              jsonPath:
                path: '{.status.phase}'
                value: Active
        - apply:
            file: 02-test-user.yaml
        - wait:
            apiVersion: iam.miloapis.com/v1alpha1
            kind: User
            name: "1001"
            timeout: 30s
            for:
              condition:
                name: Ready
                value: 'True'
        - apply:
            file: 03-organization-membership.yaml

    # Test project creation and Ready status through organizational context
    - name: test-project-creation-and-ready-status
      cluster: org
      try:
        - apply:
            file: 04-test-project.yaml
        - wait:
            apiVersion: resourcemanager.miloapis.com/v1alpha1
            kind: Project
            name: project-creation-test
            timeout: 60s
            for:
              condition:
                name: Ready
                value: 'True'
        - assert:
            file: assertions/assert-project-ready.yaml

    # Verify project shows up in main cluster context with correct status
    - name: verify-project-in-main-cluster
      cluster: main
      try:
        - assert:
            file: assertions/assert-project-exists-main.yaml
