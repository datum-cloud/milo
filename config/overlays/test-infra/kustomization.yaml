apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: milo-system

resources:
  # Test infrastructure namespace
  - resources/namespace.yaml

  # Etcd dependency for test environment
  - ../../dependencies/etcd

  # Milo control plane components - will be in milo-system
  - ../../apiserver
  - ../../controller-manager/overlays/core-control-plane

  # Deploy argo-events (controller runs on infrastructure cluster)
  - ../../dependencies/argo-system

components:
  - components/auth
  - components/certificates
  - ../../components/certificates
  - ../../components/apiserver-audit-logging
  # Ingress configuration (shared Gateway API with Envoy)
  - ../../components/gateway-api

patches:
  # Configure API server for etcd connection
  - path: patches/apiserver-patch.yaml
    target:
      kind: Deployment
      name: milo-apiserver

  # Configure controller manager for test environment
  - path: patches/controller-manager-patch.yaml
    target:
      kind: Deployment
      name: milo-controller-manager

  # Configure argo-events for test environment
  - path: patches/argo-events-patch.yaml
    target:
      kind: HelmRelease
      name: argo-events

images:
  - name: ghcr.io/datum-cloud/milo
    newTag: dev
